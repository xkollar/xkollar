<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>xkollar - Heroku and HTTPS</title>
<link rel="feed" type="application/atom+xml" href="../atom.xml" title="Atom Feed">
<link rel="shortcut icon" type="image/x-icon" href="../images/favicon.ico" sizes="16x16 32x32 48x48 64x64 128x128 256x256">
<link rel="stylesheet" type="text/css" href="../css/main.css">
</head>
<body><div class="wrapper"><header><span id="not-title">xkollar</span><nav><ul><li><a href="../">Main</a></li><span class="space"> </span><li><a href="../archive.html">Archive</a> <ul class="tags"><li><a href="../tags/Fun.html">Fun</a></li><span class="space"> </span><li><a href="../tags/Music.html">Music</a></li><span class="space"> </span><li><a href="../tags/Haskell.html">Haskell</a></li><span class="space"> </span><li><a href="../tags/">...</a></li></ul></li></ul></nav></header><div class="main"><h1>Heroku and HTTPS</h1><div class="info">Posted on 2017-03-15 by xkollar  <span class="tags">in <a href="../tags/Haskell.html">Haskell</a></span>.</div><p><a href="https://www.heroku.com/">Heroku</a> is a <a href="https://en.wikipedia.org/wiki/Platform_as_a_service">Platform as a Service</a> provider we have used in work for prototyping some small services. What bugged me though was that even though they provide you with free HTTPS certificate for your <code>*.herokuapp.com</code> site, the they do not provide simple way to enforce HTTPS.</p>
<p>So I have wrote simple <a href="https://hackage.haskell.org/package/wai">wai</a> <a href="https://hackage.haskell.org/package/wai-3.2.1.1/docs/Network-Wai.html#t:Middleware">Middleware</a>, which will take care of redirecting users to secured version of your site and also set <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security">HTTP_Strict_Transport_Security</a>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">herokuHttps ::</span> <span class="dt">Middleware</span>
herokuHttps <span class="fu">=</span> strictTransportPolicy <span class="fu">.</span> herokuHttpsRedirect

<span class="ot">isHerokuHttps ::</span> <span class="dt">Request</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span>
isHerokuHttps <span class="fu">=</span> (<span class="dt">Just</span> <span class="st">&quot;https&quot;</span> <span class="fu">==</span>) <span class="fu">.</span> fmap CI.mk
    <span class="fu">.</span> lookup <span class="st">&quot;X-Forwarded-Proto&quot;</span> <span class="fu">.</span> requestHeaders

<span class="ot">strictTransportPolicy ::</span> <span class="dt">Middleware</span>
strictTransportPolicy <span class="fu">=</span> ifRequest isHerokuHttps <span class="fu">.</span> modifyResponse
    <span class="fu">$</span> mapResponseHeaders ((header, value)<span class="fu">:</span>)
  <span class="kw">where</span>
    header <span class="fu">=</span> <span class="st">&quot;Strict-Transport-Security&quot;</span>
    value <span class="fu">=</span> <span class="st">&quot;max-age=31536000; includeSubDomains&quot;</span>

<span class="ot">herokuHttpsRedirect ::</span> <span class="dt">Middleware</span>
<span class="ot">#if MIN_VERSION_wai(3,0,0)</span>
herokuHttpsRedirect app r respond
<span class="ot">#else</span>
herokuHttpsRedirect app r
<span class="ot">#endif</span>
    <span class="fu">|</span> isHerokuHttps r <span class="fu">=</span> runApp
    <span class="fu">|</span> <span class="dt">Just</span> host <span class="ot">&lt;-</span> hostHeader r <span class="fu">=</span> res <span class="fu">.</span> redir
        <span class="fu">$</span> <span class="st">&quot;https://&quot;</span> <span class="fu">&lt;&gt;</span> host <span class="fu">&lt;&gt;</span> rawPathInfo r <span class="fu">&lt;&gt;</span> rawQueryString r
    <span class="fu">|</span> otherwise <span class="fu">=</span> runApp
  <span class="kw">where</span>

    <span class="co">-- Heroku does not use &quot;X-Forwarded-Host&quot;, as it simply preserves &quot;Host&quot;</span>
<span class="ot">    hostHeader ::</span> <span class="dt">Request</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">ByteString</span>
    hostHeader <span class="fu">=</span> lookup <span class="st">&quot;Host&quot;</span> <span class="fu">.</span> requestHeaders

<span class="ot">    redir ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Response</span>
    redir url <span class="fu">=</span> responseLBS HTTP.status301 [(<span class="st">&quot;Location&quot;</span>, url)] <span class="st">&quot;&quot;</span>

<span class="ot">#if MIN_VERSION_wai(3,0,0)</span>
    res <span class="fu">=</span> respond
    runApp <span class="fu">=</span> app r respond
<span class="ot">#else</span>
    res <span class="fu">=</span> return
    runApp <span class="fu">=</span> app r
<span class="ot">#endif</span></code></pre></div>
<p>Many relevant Haskell libraries use wai (<a href="http://packdeps.haskellers.com/reverse/wai">wai reverse dependencies</a> so you can use it for example with your <a href="https://hackage.haskell.org/package/servant-server">servant</a>-based service.</p>
<p>PS: You really do not need this should you have proxy configuration under your control, as all major reverse proxies can do this for you.</p>
</div><footer><p>Find me on <a href="https://github.com/xkollar/">GitHub</a>. Fancy an <a href="../atom.xml">Atom feed</a>?</p><p>H4sIAIisZlgAA3PLzy9JLdLT0wMAzFDh2gkAAAA=</p><p>Version 1, powered by <a href="https://jaspervdj.be/hakyll">Hakyll</a>.</p></footer></div></body>
</html>
